/**
 * Created by Administrator on 2016/9/7.
 */
var mysql=require("mysql");
var fs=require("fs");

var connection=mysql.createConnection({
   host:"127.0.0.1",
    port:3306,
    database:"stusys",
    user:"root",
    password:"279293"
});

var out=fs.createWriteStream("data.xls");

out.on("error", function (err) {
    console.info("数据写入文件失败"+err);
    process.exit();
})

connection.connect(function (err) {
    if(err){
        console.info("连接数据库失败"+err);
    }else {
        var result=connection.query({sql:"select * from stuinfo s, classinfo c where s.cid=c.cid",nestTables:true});
        result.on("error", function (err) {
            console.info("获取学生信息失败"+err);
            process.exit();
        });

        result.on("fields", function (fields) {//读取每一列的信息
            var str="";
            fields.forEach(function (field) {//循环所有的列
                str+=field.name+"\t";
            });
            out.write(str+"\r\n");
        })

        result.on("result", function (row) {//读取每一行的信息  每读一行触发一次
            connection.pause();//没读到一行先暂停读取后面的数据
            out.write(row.s_sid+"\t"+row.s_sname+"\t"+row.s_cid+"\t"+row.s_sex+"\t"+row.s_age+"\t","utf8",
                function (err) {
                    if(err){
                        console.info("数据写入文件失败"+err);
                        process.exit();//退出程序
                    }else {
                        connection.resume();//如果没有错误，继续读取下一行
                    }
                });
        });

        result.on("end", function () {
            console.info("学生信息读取完毕");
            connection.end();//关闭连接
        })
    }
})